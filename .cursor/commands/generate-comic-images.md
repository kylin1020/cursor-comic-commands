# generate-comic-images

## 核心执行步骤

### 步骤1：理解需求并分析内容
- 确定要生成的内容（角色/场景/分镜）、生成范围和类型
- **角色分析**：
  - 检查角色是否有多个年龄段描述（如：少年、青年、中年等），需要为**每个年龄段**单独生成基础参考图
  - 检查角色是否涉及多种场景状态（如：正常、受伤、变装等），需要为**不同场景**生成衍生图
- **场景分析**：
  - 检查场景是否有季节变化描述（如：春夏秋冬、晴雨等），需要为**每个季节/天气**生成基础参考图
  - 场景的中景、近景需要根据季节对应生成
- 读取 `style.md` 获取全局风格
- 读取相关角色/场景/分镜的md文件获取完整提示词
- 检查 outputs 目录中已存在的参考图，避免重复生成

### 步骤2：优化提示词并准备生成参数
- **提示词优化策略**：
  - 组织结构：`[前帧/尾帧核心描述] + [场景/角色细节] + [章节氛围+整体风格]`
  - 字数目标：**不超过300个汉字**，保证模型执行准确度
  - 融合关键信息：
    1. **前帧/尾帧描述**：取自分镜脚本的"画面描述"和"对白/旁白"
    2. **场景/角色核心**：角色年龄段/场景季节+关键细节（表情、动作、物品）
    3. **章节氛围**：参考 style.md 中对应**阶段的主色调和情感象征**（如"华花郎寻仙阶段"用金黄+青绿，"矿场求生"用暗灰+血红）
    4. **风格融合**：精选 style.md 中的**最核心通用词**（日系新海诚、明亮对比、中国古风、高质量画面）
  - 范例结构：`[时间背景][具体场景][角色状态][主要动作/表情]，[相关细节]。[氛围色调][核心风格词]`
  - **对多年龄段/季节**：在提示词中明确标注（如"年轻时期""秋季阴雨"）
- **分镜特殊处理**：开头明确说"画两张图片。第一张图：...。第二张图：..."，设置 `num_images=2`，确保前尾帧视觉连贯
- **准备参考图（最多6张）**：
  - 角色衍生图：使用**对应年龄段/场景的正面照**作为参考
  - 场景衍生图：使用**对应季节/天气的远景图**作为参考
  - 分镜：使用角色正面照（对应年龄段） + 场景远景（对应季节） + (可选)前一分镜尾帧

### 步骤3：按顺序分批生成（考虑内容变体）
**第一轮**：生成基础参考图 - 不使用参考图
  - 每个角色的**每个年龄段** → 生成对应正面照
  - 每个场景的**每个季节/天气变化** → 生成对应远景图
**第二轮**：生成衍生图 - 使用对应的基础参考图
  - 对应年龄段/场景状态的三视图、表情、动作等
  - 对应季节的中景、近景等
**第三轮**：生成分镜 - 最多3个并发任务（6张图）
  - 使用角色的对应年龄段正面照 + 场景的对应季节远景作参考

### 步骤4：质量检查
- 生成完成后，自动读取所有图片进行快速检查
- 仅在发现问题时输出简洁报告
- 问题图片重新生成，可将成功的图作为reference_images之一

### 步骤5：最终报告
- 简洁展示：✅ 成功 X 张 / ❌ 失败 Y 张
- 按类型分组列出生成的图片路径

---

## 重要约束条件

### 生成顺序（必须遵循）
**角色图**：正面照 → 三视图 → 表情 → 动作（每个都用正面照作参考）
**场景图**：远景 → 中景 → 近景（每个都用远景作参考）
**分镜图**：最后生成，前帧+尾帧关联生成（num_images=2）

### 输出路径规范
**角色图**：`outputs/characters/[角色名]/[类型].png`
- 正面照：`outputs/characters/[角色名]/正面照.png`
- 三视图：`outputs/characters/[角色名]/三视图.png`
- 表情参考：`outputs/characters/[角色名]/表情参考图.png`
- 动作参考：`outputs/characters/[角色名]/动作参考图.png`

**场景图**：`outputs/scenes/[场景名]/[类型].png`
- 远景：`outputs/scenes/[场景名]/远景.png`
- 中景：`outputs/scenes/[场景名]/中景.png`
- 近景：`outputs/scenes/[场景名]/近景.png`

**分镜图**：`outputs/chapters/[章节名]/[分镜号]-[分镜名称]_[帧号].png`
- 例如：`outputs/chapters/chapter-001/分镜01-开篇远景_1.png`（前帧）
- 例如：`outputs/chapters/chapter-001/分镜01-开篇远景_2.png`（尾帧）

### 通用规则
- 基础参考图（正面照、远景）**不使用**参考图，纯文本生成
- 衍生图**必须**使用对应的基础参考图，确保一致性
- 同一角色/场景的所有衍生图使用同一张基础参考图
- 目录不存在则自动创建
- 文件名严格按照上述格式，确保文件组织清晰

### 分镜生成特殊规则
- 每次最多并发3个分镜任务（6张图）
- 提示词格式必须包含"画两张图片"的明确指示
- 如当前分镜与前一分镜有连续性（场景/角色/镜头相关），将前一分镜尾帧加入参考图
- 局部问题重试：将成功的那一帧加入reference_images后重新生成

---

## 质量检查关键点

### 人物年龄一致性（最关键 🔴）
- **同一角色必须年龄始终一致**，不能出现 ±5 岁以上的差异
- 检查项：皱纹深度、脸部饱满度、眼睛状态、头发花白程度、脸型骨架
- 生成时用同一张正面照作参考图；检查时并排查看正面照和衍生图
- 如发现不符，立即重新生成

### 画风一致性 🎨
- **必须符合 style.md 设定**：线条风格、色彩搭配、光影效果、纹理质感
- 同一系列图（正面照/三视图/表情/动作）的画风必须高度一致
- 同一场景的多角度画风要协调
- 常见问题：颜色突变、线条粗细不一、风格不搭配

### 其他检查
- **内容一致性**：图片内容是否与提示词一致
- **角色/场景一致性**：不同图片中外貌/风格是否一致
- **明显瑕疵**：生成失真、异常现象
- **提示词一致性**：风格描述是否来自 style.md

---

## 分镜生成最佳实践

### 核心原则
前帧和尾帧是同一镜头的开始和结束，必须关联生成以保证：
- 视觉连贯性：角色外貌、场景风格、光线一致
- 动作流畅性：过渡自然
- 时空一致性：同一时间段

### 生成模式选择指南

| 场景 | 推荐模式 | 说明 |
|------|---------|------|
| 常规过渡分镜 | 标准模式 `num_images=2` | 效率高，并发生成两帧 |
| 关键分镜 | 高质量模式逐帧 | 开篇、转折、高潮等 |
| 复杂动作过渡 | 高质量模式逐帧 | 需要精细渐进的动作/表情变化 |
| 角色状态演变 | 高质量模式逐帧 | 从受伤→恢复、害怕→勇敢等渐进式心理变化 |
| 不确定或重新生成 | 先尝试标准 → 不满意切换高质量 | 灵活调整策略 |

### 参考图选择
1. 分镜中出现的角色的正面照
2. 分镜对应场景的远景图
3. (可选) 寻找一些可能有关联的帧画面作为参考输入 - 如果有连续性（场景相同、角色动作延续、镜头推拉）

### 提示词格式与优化示例

#### 提示词结构
```
画两张图片。
第一张图：[前帧描述] 采用[章节氛围色调]的[整体风格]。
第二张图：[尾帧描述] 保持[前帧关键元素]，采用[章节氛围色调]的[整体风格]。
```

#### 实例分析（第1章-矿场求生阶段）

**原始分镜信息**：
- 分镜001：农家院落被洗劫，田林和老头儿衣衫褴褛，天色阴沉
- 章节氛围：矿场求生阶段 → 主色暗灰+血红，情感压抑绝望

**优化后提示词**（控制在300汉字以内）：
```
画两张图片。
第一张图：破败的农家院落全景，篱笆推倒散落，土房门半开。远处衣衫褴褛的田林和老头儿从右侧走来，天色阴沉萧瑟。
第二张图：保持同一场景，两人走近，表情哀伤，篱笆破损的细节清晰。采用暗灰色调+压抑气息，阳光微弱，强烈阴影。日系新海诚风格、中国古风建筑、明亮对比、高质量精细画面。
```

**提示词优化要点**：
1. ✅ 融合前帧/尾帧：开头明确指示"两张图"，分别描述前后状态
2. ✅ 章节氛围+整体风格：暗灰+压抑+日系新海诚+古风融合
3. ✅ 关键细节：衣衫褴褛、阴沉、篱笆、土房等核心元素
4. ✅ 视觉连贯性：两帧保持同场景、同时段、同角色状态
5. ✅ 字数控制：约180个汉字，留足参考图对连贯性的补强空间

### 提示词优化速查表

| 要素 | 来源 | 示例 | 优先级 |
|------|------|------|--------|
| 前帧/尾帧描述 | 分镜脚本"画面描述" | "院落全景/两人走近" | 🔴必须 |
| 角色年龄段 | 角色文件 | "年轻时期/中年" | 🔴必须 |
| 场景季节 | 场景文件 | "春季/阴雨/夜晚" | 🔴必须 |
| 关键动作/表情 | 分镜脚本 | "衣衫褴褛/哀伤表情" | 🟡重要 |
| 章节主色调 | style.md对应阶段 | "暗灰+血红/金黄+青绿" | 🟡重要 |
| 情感象征 | style.md对应阶段 | "压抑绝望/希望希冀" | 🟡重要 |
| 核心风格词 | style.md通用词 | "日系新海诚、明亮对比" | 🟢补强 |
| 细节元素 | 原始描述 | "篱笆、土房、阳光" | 🟢补强 |

**删除原则**：优先保留颜色表上"必须"项，其次保留"重要"项，根据字数取舍"补强"项

### 生成策略

#### 标准模式（高效）
- 按顺序分批生成，每批3-5个分镜
- 每批最多3个并发任务（6张图）
- 后续分镜可使用前面已生成的分镜尾帧作为参考
- **适用场景**：常规分镜、时间不紧张、对连贯性要求一般的分镜

#### 高质量模式（逐帧生成）✨
- **适用场景**：
  - 关键分镜（开篇、转折、高潮）
  - 需要精细的动作过渡
  - 前帧/尾帧关联性要求极高
  - 角色表情/状态需要渐进式演变
  
- **流程**：
  1. 生成第一张图（前帧）
  2. **将第一张图作为参考输入**，生成第二张图（尾帧）
  3. 通过参考图强化视觉连贯性：角色位置、姿势、表情的自然递进
  4. 如需微调，可将第二张图再作为参考进行部分重新生成

- **提示词调整**：
  ```
  第一张图提示词：详细描述前帧状态（独立生成）
  
  第二张图提示词：
  第二张图：[尾帧描述]。基于第一张图[关键细节]，继续[动作变化/表情演变]。
  采用[章节氛围色调]的[整体风格]。
  ```

- **参考图设置**：
  ```
  第一张图：不使用参考图（纯文本生成）
  第二张图：使用第一张图作为参考输入（强化关联性）
  ```

- **效果说明**：
  - 第一张图为"基准"，定下角色、场景、光影的核心特征
  - 第二张图使用第一张作参考，确保完全一致的角色/场景/风格
  - 尾帧通过提示词指导"动作/表情的自然递进"
  - 最终形成"同一镜头内的流畅过渡"

| 对比维度 | 标准模式 | 高质量模式 |
|---------|---------|----------|
| 时间成本 | 低（并发） | 高（串行） |
| 视觉连贯性 | 中等 | 极高 |
| 关键分镜质量 | 一般 | 优秀 |
| 推荐使用频率 | 日常分镜 | 5-10%关键分镜 |
