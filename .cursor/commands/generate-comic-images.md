# generate-comic-images

## 核心执行步骤

### 步骤1：理解需求并分析内容
- 确定要生成的内容（角色/场景/分镜）、生成范围和类型
- **角色分析**：
  - 检查角色是否有多个年龄段描述（如：少年、青年、中年等），需要为**每个年龄段**单独生成基础参考图
  - 检查角色是否涉及多种场景状态（如：正常、受伤、变装等），需要为**不同场景**生成衍生图
- **场景分析**：
  - 检查场景是否有季节变化描述（如：春夏秋冬、晴雨等），需要为**每个季节/天气**生成基础参考图
  - 场景的中景、近景需要根据季节对应生成
- **读取并提取关键信息（多层次融合）**：
  - 读取 `style.md` 提取**全局风格关键词**（画风、色调、光影、线条等，约50字）
  - 读取当前章节storyboard.md提取**章节氛围关键词**（情绪、色调、节奏等，约30字）
  - 读取分镜md提取**画面描述**（这是核心内容，包含场景、角色、动作、表情等视觉元素）
  - 读取相关角色/场景md获取**角色/场景细节**（外貌特征、场景布局等）
- 检查 outputs 目录中已存在的参考图，避免重复生成

### 步骤2：优化提示词并准备生成参数
- **提示词构建（多层次融合，总长≤300汉字）**：
  - **基础结构**（角色/场景）：`[全局风格50字] + [具体内容描述] + [年龄段/季节标注]`
  - **分镜结构**（单张生成，前后帧关联）：
    ```
    前帧：[镜头类型] + [画面描述核心内容120-150字] + [全局风格30字] + [章节氛围20字] + [与前一分镜关联20字(如有)]
    尾帧：[镜头类型] + [画面描述核心内容120-150字] + [全局风格30字] + [章节氛围20字] + [与前帧延续描述20字]
    ```
  - **画面描述是核心**（最重要）：
    - **必须包含**storyboard中的"画面描述"内容，这是最核心的视觉元素
    - 画面描述包括：场景环境、角色外貌动作、表情、物品细节、光影氛围等
    - 前帧和尾帧的画面描述必须有**连续性和关联性**（同一镜头的开始和结束）
  - **提取与压缩技巧**：
    - 画面描述保留核心视觉元素，压缩冗长表达
    - 全局风格和章节氛围精简为关键词
    - 删除无关修饰词，用简洁词汇替代
    - 年龄段/季节必须明确标注（如"少年时期""秋季黄昏"）
- **准备参考图（最多6张，尽量找满）**：
  - **角色衍生图**：使用**对应年龄段/场景的正面照**（1张）
  - **场景衍生图**：使用**对应季节/天气的远景图**（1张）
  - **分镜前帧**（最多6张）：
    1. 分镜中出现的角色正面照（对应年龄段，1-3张）
    2. 分镜对应场景的远景图（对应季节，1张）
    3. 前一分镜的尾帧（如有连续性，1张）
    4. 相关场景/角色的其他参考图（如特殊表情、动作等，1-2张）
  - **分镜尾帧**（最多6张，关键是前帧）：
    1. **本分镜的前帧**（必须，1张）
    2. 分镜中出现的角色正面照（对应年龄段，1-3张）
    3. 分镜对应场景的远景图（对应季节，1张）
    4. 相关参考图（如特殊表情、动作等，0-1张）

### 步骤3：按顺序分批生成（考虑内容变体）
**第一轮**：生成基础参考图 - 不使用参考图
  - 每个角色的**每个年龄段** → 生成对应正面照
  - 每个场景的**每个季节/天气变化** → 生成对应远景图
**第二轮**：生成衍生图 - 使用对应的基础参考图
  - 对应年龄段/场景状态的三视图、表情、动作等
  - 对应季节的中景、近景等
**第三轮**：生成分镜（逐帧顺序生成）
  - **按分镜顺序**，先生成前帧，再生成尾帧
  - 前帧：使用角色正面照 + 场景远景 + 前一分镜尾帧（如有） + 其他参考图
  - 尾帧：**必须使用前帧** + 角色正面照 + 场景远景 + 其他参考图
  - 可并发生成多个分镜的前帧（3-5个），但尾帧必须等对应前帧生成完成
  - 每次并发不超过5个任务

### 步骤4：质量检查
- 生成完成后，自动读取所有图片进行快速检查
- **分镜图片必须检查**：
  - 画面描述符合性：逐项对照storyboard的画面描述
  - 前帧/尾帧关联性：并排对比，检查场景、角色、光线、动作连贯性
  - 人物年龄一致性：与角色正面照对比
  - 画风一致性：与style.md设定对比
- 仅在发现问题时输出简洁报告（列出不符合项）
- 问题图片重新生成，将成功的图作为reference_images之一

### 步骤5：最终报告
- 简洁展示：✅ 成功 X 张 / ❌ 失败 Y 张
- 按类型分组列出生成的图片路径

---

## 重要约束条件

### 生成顺序（必须遵循）
**角色图**：正面照 → 三视图 → 表情 → 动作（每个都用正面照作参考）
**场景图**：远景 → 中景 → 近景（每个都用远景作参考）
**分镜图**：最后生成，单张逐帧生成（前帧 → 尾帧，尾帧必须使用前帧作为参考图）

### 输出路径规范
**角色图**：`outputs/characters/[角色名]/[类型].png`
- 正面照：`outputs/characters/[角色名]/正面照.png`
- 三视图：`outputs/characters/[角色名]/三视图.png`
- 表情参考：`outputs/characters/[角色名]/表情参考图.png`
- 动作参考：`outputs/characters/[角色名]/动作参考图.png`

**场景图**：`outputs/scenes/[场景名]/[类型].png`
- 远景：`outputs/scenes/[场景名]/远景.png`
- 中景：`outputs/scenes/[场景名]/中景.png`
- 近景：`outputs/scenes/[场景名]/近景.png`

**分镜图**：`outputs/chapters/[章节名]/[分镜号]-[分镜名称]_[帧号].png`
- 例如：`outputs/chapters/chapter-001/分镜01-开篇远景_1.png`（前帧）
- 例如：`outputs/chapters/chapter-001/分镜01-开篇远景_2.png`（尾帧）

### 通用规则
- 基础参考图（正面照、远景）**不使用**参考图，纯文本生成
- 衍生图**必须**使用对应的基础参考图，确保一致性
- 同一角色/场景的所有衍生图使用同一张基础参考图
- 目录不存在则自动创建
- 文件名严格按照上述格式，确保文件组织清晰

### 分镜生成特殊规则
- **单张生成原则**：每次生成一张图（num_images=1），前帧和尾帧分开生成
- **尾帧强制依赖**：尾帧必须将对应的前帧放入参考图第一位
- **参考图尽量找满**：每次生成尽量准备6张参考图，包括：
  - 核心参考（前帧/正面照/远景）
  - 辅助参考（表情、动作、前序分镜、相关场景等）
- **连续性处理**：如当前分镜与前一分镜有连续性（场景/角色/镜头相关），将前一分镜尾帧加入前帧的参考图
- **重试策略**：如需重新生成，将已有的相关成功图片作为参考图

---

## 质量检查关键点

### 画面描述符合性（最关键 🔴）
- **生成的图片必须符合storyboard中的画面描述**
- 检查项（逐项对照）：
  - 场景环境是否正确（如：农家院落、篱笆、土房等）
  - 角色外貌是否符合（年龄、发型、衣着、体态等）
  - 角色动作/姿态是否正确（如：拄竹竿、眉头紧皱等）
  - 物品细节是否准确（如：牛粪、虫儿草等特写物品）
  - 光影氛围是否符合（如：阴沉天色、荒凉氛围等）
- **如不符合画面描述，必须重新生成**

### 前帧/尾帧关联性（分镜专属 🔴）
- **前帧和尾帧是同一镜头的连续画面，必须高度关联**
- 检查项（并排对比）：
  - 场景环境是否一致（同一地点、同一角度）
  - 角色外貌是否一致（发型、衣着、年龄）
  - 光线和色调是否一致（不能从白天跳到晚上）
  - 动作是否连贯（前帧动作的延续，而非突变）
  - 镜头视角是否一致（不能从远景跳到特写）
- 常见问题：场景突变、人物换装、光线跳变、镜头跳切
- **如关联性差，必须重新生成尾帧**（使用前帧作为核心参考）

### 人物年龄一致性 🔴
- **同一角色在不同图片中年龄必须一致**，不能出现 ±5 岁以上的差异
- 检查项：皱纹深度、脸部饱满度、眼睛状态、头发花白程度、脸型骨架
- 生成时用同一张正面照作参考图；检查时并排查看正面照和衍生图
- 如发现不符，立即重新生成

### 画风一致性 🎨
- **必须符合 style.md 设定**：线条风格、色彩搭配、光影效果、纹理质感
- 同一系列图（正面照/三视图/表情/动作）的画风必须高度一致
- 同一场景的多角度画风要协调
- 常见问题：颜色突变、线条粗细不一、风格不搭配

### 其他检查
- **明显瑕疵**：生成失真、异常现象、人物畸形等
- **细节完整性**：重要道具/物品是否清晰可见

---

## 分镜生成最佳实践

### 核心原则
前帧和尾帧是同一镜头的开始和结束，通过**单张逐帧生成+多参考图**保证：
- 视觉连贯性：角色外貌、场景风格、光线一致
- 动作流畅性：尾帧使用前帧作为核心参考，确保过渡自然
- 时空一致性：通过全局风格+章节氛围融入提示词
- 生成质量：单张生成比双张生成质量更高

### 参考图选择策略（尽量找满6张）

**前帧参考图（按优先级排序）**：
1. 分镜中出现的角色正面照（对应年龄段，1-3张）
2. 分镜对应场景的远景图（对应季节，1张）
3. 前一分镜的尾帧（如有连续性，1张）
4. 角色表情/动作参考图（如有特殊需求，0-2张）
5. 相关场景的中景/近景（如有特殊构图需求，0-1张）

**尾帧参考图（按优先级排序）**：
1. **本分镜的前帧**（必须，第一位，1张）
2. 分镜中出现的角色正面照（对应年龄段，1-3张）
3. 分镜对应场景的远景图（对应季节，1张）
4. 角色表情/动作参考图（如有特殊需求，0-2张）

### 提示词格式（单张生成）

**结构说明**：
```
前帧提示词（总长≤300字）：
[镜头类型] + [画面描述核心内容120-150字] + [全局风格30字] + [章节氛围20字] + [与前序连续性20字(如有)]

尾帧提示词（总长≤300字）：
[镜头类型] + [画面描述核心内容120-150字] + [全局风格30字] + [章节氛围20字] + [与前帧延续20字]
```

**示例（基于分镜001）**：
```
前帧：
远景。破败的农家院落全景，简陋的土房，被推倒的篱笆院墙散落一地。远处山峦起伏，天色阴沉灰暗。右侧小径上，两个衣衫褴褛的小人影正走向院落。院子荒凉，杂草丛生。采用日系新海诚风格与中国古风元素融合，阴沉色调、荒凉氛围、明暗对比、精细细节、高质量精美画面。

尾帧：
远景。同一农家院落全景，环境不变。两个人影已走近院落入口，田林拄着竹竿，老头儿在前。破败的篱笆更加清晰，土房门半开。天色依然阴沉。采用日系新海诚风格与中国古风元素融合，阴沉色调、荒凉氛围、明暗对比、精细细节、高质量精美画面。与前帧环境一致，人物位置变化。
```

**关键要点**：
- 画面描述是核心，必须详细且准确
- 前后帧画面描述要有连续性（同一场景、角色动作延续）
- 全局风格和章节氛围保持一致，确保整体画风统一
- 明确标注与前序画面的关联

### 生成策略
- **按分镜顺序生成**：确保可以使用前序分镜作为参考
- **前帧批量，尾帧逐个**：
  - 可并发生成3-5个分镜的前帧
  - 等所有前帧完成后，逐个生成对应尾帧（或小批量并发）
- **参考图动态积累**：后续分镜可使用前面已生成的分镜尾帧作为参考
