# generate-comic-images

## 📋 任务清单

### 阶段1：需求分析与确认
- [ ] 理解用户需求：解析用户想要生成的内容类型（角色/场景/分镜/自定义）
- [ ] 确定生成范围：明确要生成哪些角色、场景或章节的图片
- [ ] 确认图片类型：确定每个对象要生成的具体类型（正面照/三视图/表情/动作/远景/中景/近景等）
- [ ] 检查参考图存在性：对于需要参考图的生成（如三视图、表情图等），检查是否已有正面照或其他参考图

### 阶段2：读取配置与提示词
- [ ] 验证项目结构：确认项目已初始化，相关目录和文件存在
- [ ] 读取全局风格：从 style.md 获取风格设定，确保生成一致性
- [ ] 读取角色信息：从 characters/ 目录读取相关角色的md文件和提示词
- [ ] 读取场景信息：从 scenes/ 目录读取相关场景的md文件和提示词
- [ ] 读取分镜信息：如需生成分镜，从 chapters/ 目录读取storyboard.md
- [ ] 查找参考图：检查outputs目录中已存在的参考图（正面照、远景图等）

### 阶段3：准备生成参数
- [ ] 提取所有提示词：从md文件中提取完整的AI生成提示词
- [ ] 准备参考图输入：为需要保持一致性的生成准备reference_images参数（使用正面照、远景图等作为输入）
- [ ] 设置输出路径：为每张图片确定正确的输出目录和文件名
- [ ] 分析依赖关系：识别哪些图片可以并行生成，哪些必须按顺序生成

### 阶段4：批量生成图片
- [ ] 确认输出目录（不存在则创建）
- [ ] 第一轮：并发生成所有基础参考图（不依赖其他图片的正面照、远景等）
- [ ] 第二轮：并发生成所有使用已存在参考图的衍生图片（三视图、表情、动作、中景、近景等）
- [ ] 第三轮：如有分镜，并发生成分镜图（一次最多3张, 使用已有角色和场景参考图）
- [ ] 每一轮显示进度（"第1轮: 正在并发生成 3 张基础参考图..."）
- [ ] 记录失败项并在该轮结束后重试

### 阶段5：验证与总结
- [ ] 统计生成结果（成功/失败数量）
- [ ] 简洁展示生成的图片列表（按类型分组）
- [ ] 如有失败项，说明失败原因

### 阶段6：自动质量检查与重新生成
- [ ] 读取并检查所有生成的图片
- [ ] 仅在发现问题时输出简洁报告（列出问题图片及具体问题）
- [ ] 使用优化参数重新生成并替换失败项, 有的时候是局部失败则应该将失败的图片作为reference_images之一输入重新生成, 提示修改的地方


## 执行流程

### 第一步：理解用户需求

询问或解析用户想要生成的内容范围，支持以下场景：

1. **生成角色图片**
   - 单个角色的全部参考图（正面照、三视图、表情图、动作图）
   - 多个角色的特定类型图片（如所有角色的正面照）
   - 指定角色的指定类型图片

2. **生成场景图片**
   - 单个场景的全部角度图（远景、中景、近景）
   - 多个场景的特定角度
   - 指定场景的指定角度

3. **生成分镜图片**
   - 指定章节的所有分镜
   - 指定章节的部分分镜（如第5-10个镜头）

4. **自定义生成**
   - 用户提供自定义提示词直接生成

### 第二步：读取相关配置

根据用户指定的范围，读取对应的md文件获取提示词：
- 读取 `style.md` 获取全局风格设定
- 读取 `characters/<角色名>.md` 获取角色提示词
- 读取 `scenes/<场景名>.md` 获取场景提示词
- 读取 `chapters/<章节名>/storyboard.md` 获取分镜提示词

### 第三步：准备生成参数

为每个需要生成的图片准备以下内容：
- **提示词**: 从md文件中提取或用户自定义的完整描述
- **参考图**: 用于保持一致性的参考图输入
  - 角色三视图/表情/动作图：使用该角色的正面照作为参考
  - 场景中景/近景：使用该场景的远景图作为参考
  - 分镜：使用对应角色的正面照和场景图作为参考
  - 基础参考图（正面照、远景）：不使用参考图，纯文本生成
- **输出路径**: 输出目录和文件名（遵循命名规范）

### 第四步：生成报告

完成后简洁展示：
- ✅ 成功生成 X 张图片
- ❌ 失败 Y 张（如有，说明原因）
- 按类型分组列出图片路径

## 使用示例

### 示例1：生成单个角色的全部参考图
```
用户：生成李小明的全部角色参考图
```
系统会生成：
- `outputs/characters/李小明/正面照.png` (正面照)
- `outputs/characters/李小明/三视图.png` (三视图)
- `outputs/characters/李小明/表情参考.png` (表情参考图)
- `outputs/characters/李小明/动作参考.png` (动作参考图)

### 示例2：生成所有角色的正面照
```
用户：生成所有角色的正面照
```
系统会为每个角色生成正面照

### 示例3：生成特定场景的全部角度
```
用户：生成咖啡厅场景的全部视图
```
系统会生成：
- `outputs/scenes/咖啡厅/远景.png` (远景)
- `outputs/scenes/咖啡厅/中景.png` (中景)
- `outputs/scenes/咖啡厅/近景.png` (近景)


## 注意事项

1. **画面比例统一**: 所有图片统一使用16:9的横向比例，便于后续漫画制作和展示
2. **参考图优先**: 生成三视图、表情、动作等衍生图片时，**必须**使用正面照作为参考图输入
3. **基础图先行**: 如果正面照或远景图不存在，必须先生成这些基础参考图
4. **提示词质量**: 确保从md文件中读取的提示词完整且格式正确
5. **文件命名**: 遵循项目的命名规范，保持一致性
6. **目录结构**: 确保输出目录存在，不存在则自动创建
7. **生成速度**: AI图像生成需要时间，耐心等待，不要中断
8. **成本控制**: 每次生成都会消耗API额度，建议先生成少量测试
9. **风格一致性**: 使用相同的 style.md 设定确保所有图片风格统一
10. **参考图一致性**: 同一角色/场景的所有衍生图片应使用同一张基础参考图，确保视觉连贯
11. **批量处理**: 对于大量图片生成，建议分批进行，避免超时
12. **错误处理**: 如果某张图片生成失败，记录下来并在最后统一重试

## 生成顺序建议

为了保持图片一致性和高效管理工作流程，**必须**按以下顺序生成：

### 角色图片生成顺序（必须按顺序）
1. **首先生成正面照** - 作为角色的基础参考图（纯文本生成，不使用参考图）
2. **使用正面照生成三视图** - 将正面照作为reference_images输入，保持角色外貌一致
3. **使用正面照生成表情参考图** - 将正面照作为reference_images输入，保持角色特征
4. **使用正面照生成动作参考图** - 将正面照作为reference_images输入，保持角色形象

### 场景图片生成顺序（必须按顺序）
1. **首先生成远景图** - 作为场景的基础参考图（纯文本生成，不使用参考图）
2. **使用远景图生成中景图** - 将远景图作为reference_images输入，保持场景风格
3. **使用远景图生成近景图** - 将远景图作为reference_images输入，保持场景细节

### 分镜图片生成顺序
- **最后生成分镜图** - 使用已生成的角色正面照和场景图作为reference_images输入

### 重要说明
- ⚠️ **严格遵循顺序**：必须先生成基础参考图（正面照、远景），再生成衍生图片
- ✅ **一致性保证**：使用参考图可以确保角色外貌、场景风格在不同图片中保持高度一致
- 🎯 **智能检查**：生成前检查是否已有参考图，如缺失则自动先生成基础参考图

## 自动质量检查流程

所有图片生成完成后，系统将自动执行以下检查流程：

### 第一步：读取并分析所有生成的图片

系统会自动读取 `outputs/` 目录下所有本次生成的图片文件，支持查看图片内容并进行智能分析。

### 第二步：执行质量检查

对每张图片快速检查以下关键问题：

#### 检查重点
- 内容是否与提示词一致
- 画风是否符合 style.md 设定
- 角色/场景在不同图片中的一致性
- 明显的生成瑕疵或失真
- **人物图特别检查**：外貌/年龄/体态是否明显不符合角色设定
- **场景图特别检查**：是否跟参考图（如果存在）明显不一致，或出现不合常理的物品

注：仅在发现明确问题时记录，无需逐项详细说明

### 第三步：生成检查报告

系统会自动执行质量检查，仅在发现问题时输出简洁报告：

```
✅ 已生成 10 张图片，全部符合要求
```

或者（如果有问题）：

```
✅ 已生成 10 张图片，其中 6 张合格

⚠️ 以下图片存在问题：

1. 苏菲亚·贝格姆/表情参考.png
   问题：面部特征与正面照不一致、发型有偏差

2. 传统银行分行办公室/中景.png
   问题：建筑风格与远景图不匹配

是否重新生成这 3 张图片？
```

## ⚠️ 质量检查关键点 - 重点检查项

### 人物脸部年龄一致性检查（最重要 🔴）

- ✅ **同一角色的年龄必须始终一致**
  - 正面照中的年龄 = 三视图中的年龄 = 表情图中的年龄 = 动作图中的年龄
  - 不能出现"正面照是中年，三视图就变成年轻小伙"的情况
  - 不能出现"一张图看起来30岁，下一张图看起来50岁"的现象

- ⚠️ **特别警惕的情况**：
  - [ ] 皱纹深度是否一致（年长角色）
  - [ ] 脸部饱满度是否一致
  - [ ] 眼睛状态是否一致（年长者眼神浑浊度）
  - [ ] 头发白度/花白程度是否一致（如有须眉角色）
  - [ ] 脸部骨架宽度是否一致

- 🔄 **参考图对比**：
  - 生成三视图/表情/动作时，**必须**使用同一张正面照作为参考图
  - 在生成前视觉对比：参考图中角色看起来多大年纪？生成结果是否符合？
  - 如发现年龄明显不符，**立即重新生成**

- 📋 **检查流程**：
  - 生成后将正面照和衍生图并排查看
  - 快速判断：脸部特征（皱纹、肤质、眼睛、脸型）是否明显不同
  - 如有不确定，放大查看眼周和脸型细节

### 其他外貌一致性检查

- ✅ **脸型轮廓** - 从不同角度看脸型是否一致
- ✅ **五官特征** - 眼睛、鼻子、嘴巴、耳朵在不同图中是否认可度高
- ✅ **头发风格** - 发型、长度、颜色、卷度是否一致
- ✅ **肤色** - 肤色深浅是否统一
- ✅ **特殊标记** - 疤痕、胎记、痣等是否保持

### 场景一致性检查

- ✅ **建筑/环境风格** - 远景、中景、近景的建筑风格是否统一
- ✅ **色彩搭配** - 场景配色是否保持一致
- ✅ **光线方向** - 光源是否来自同一方向
- ✅ **物品放置** - 道具位置逻辑是否合理

### 提示词一致性检查

- ✅ **确认参考图已应用** - 检查生成参数中是否正确包含了reference_images
- ✅ **提示词中的年龄信息** - 确保提示词中的年龄描述与参考图一致
- ✅ **风格描述** - 所有提示词中的风格设定来自style.md且一致

**💡 建议：严格要求人物年龄一致性，宁可多重新生成几次也要确保质量！**
